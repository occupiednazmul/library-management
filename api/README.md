# API — Library Service (Express + Mongoose + Zod)

This folder implements a small REST API for a library system. It exposes endpoints to **create/edit/list books**, **aggregate borrow activity**, and fetch **latest books** (and optionally **popular books**).

The API is written in **TypeScript**, uses **Express** for routing, **Mongoose** for MongoDB models/transactions, and **zod** for robust input validation.

---

## Contents

- [Tech Stack](#tech-stack)
- [Directory](#directory)
- [Data Models](#data-models)
  - [Book](#book)
  - [Borrow](#borrow)
- [Validation & Normalization](#validation--normalization)
- [Endpoints](#endpoints)
  - [Books](#books)
  - [Borrow](#borrow-1)
  - [Latest & Popular](#latest--popular)
- [Pagination, Sorting & Filtering](#pagination-sorting--filtering)
- [Transactions & Inventory Logic](#transactions--inventory-logic)
- [Error Handling](#error-handling)
- [Indexing Recommendations](#indexing-recommendations)
- [Notes & Extensibility](#notes--extensibility)

---

## Tech Stack

- **Express** for routing
- **Mongoose** models & transactions
- **zod** schemas for request validation and value transforms
- **TypeScript** throughout
- Centralized helpers in `global.handlers.ts` (e.g., `responseCodes`, error helpers)

---

## Directory

```
api/
  index.ts                 # Express app & router mounting
  global.handlers.ts       # Shared response codes / error helpers
  books.model.ts           # Mongoose Book model + zod validation
  borrow.model.ts          # Mongoose Borrow model + zod validation
  books.controller.ts      # /api/books routes
  borrow.controller.ts     # /api/borrow routes
```

---

## Data Models

### Book

Fields (see `books.model.ts`):

| Field        | Type    | Notes |
|--------------|---------|------|
| `title`      | string  | required |
| `author`     | string  | required; **normalized** (trim, single spaces, capitalized incl. dotted initials) |
| `genre`      | enum    | one of: `Fiction`, `Non-fiction`, `Science`, `History`, `Biography`, `Fantasy`, `Uncategorized`; default `Uncategorized` |
| `isbn`       | string  | required; **normalized** by removing dashes/spaces; **unique** |
| `description`| string  | required |
| `copies`     | number  | required; `>= 0` |
| `available`  | boolean | required; maintained automatically when `copies` changes |
| `imageURI`   | string? | optional |
| `createdAt`  | Date    | generated by Mongoose timestamps |
| `updatedAt`  | Date    | generated by Mongoose timestamps |

**Statics**

- `decrementCopies(bookId, quantity, session?)`: validates existence and stock, decrements `copies`, and sets `available = copies > 0` atomically.

**Middleware**

- `pre('findOneAndUpdate')`: if `copies` is present in update, auto-sets `available = copies > 0`.

---

### Borrow

Fields (see `borrow.model.ts`):

| Field       | Type                | Notes |
|-------------|---------------------|------|
| `book`      | ObjectId (Book)     | required; ref `Book` |
| `quantity`  | number              | required; `>= 1` |
| `dueDate`   | Date                | required (parsed from ISO string) |
| `createdAt` | Date                | timestamps |
| `updatedAt` | Date                | timestamps |

---

## Validation & Normalization

zod schemas (in `books.model.ts` / `borrow.model.ts`) ensure:

- **Books (body validation)**
  - `author` is normalized: trimmed, lowercased, squashed spaces, then capitalized word-by-word; dotted initials (e.g. `a.b.`) are capitalized per segment.
  - `isbn` has **dashes and spaces stripped**.
  - `genre` constrained to enum; default `Uncategorized`.
  - `copies >= 0`; `available` boolean.
- **Books (query validation)** for listing:
  - `author?: string`
  - `genre?: enum`
  - `available?: 'true'|'false'` → transformed to boolean
  - `sortBy: 'asc' | 'desc'` default `'desc'` (by `createdAt`)
  - `resultsPerPage: '10'|'20'|'50'|'100'` → transformed to number
  - `page: string` default `'1'` → transformed to number
- **Borrow (body validation)**
  - `book: string` (ObjectId as string)
  - `quantity >= 1`
  - `dueDate: string` → transformed to `Date`

Invalid payloads yield a 400 with a consistent error shape (see *Error Handling*).

---

## Endpoints

### Books

`/api/books`

- **GET** — list books with filtering, sorting and pagination.
  - Query:
    - `author?: string`
    - `genre?: 'Fiction'|'Non-fiction'|'Science'|'History'|'Biography'|'Fantasy'|'Uncategorized'`
    - `available?: 'true'|'false'`
    - `sortBy?: 'asc'|'desc'` (by `createdAt`; default `desc`)
    - `resultsPerPage?: '10'|'20'|'50'|'100'` (default `10`)
    - `page?: string` (default `'1'`)
  - Response:
    ```json
    {
      "success": true,
      "booksCount": 42,
      "message": "10 books provided.",
      "data": [ /* TBook[] */ ]
    }
    ```

- **POST** — create a new book.
  - Body: `TBookNew` (see schema above)
  - Success (201):
    ```json
    {
      "success": true,
      "message": "'A Title' listed.",
      "data": { /* created book */ }
    }
    ```
  - Duplicate ISBN yields a 400-like error with code `11000` normalized by the global handler.

`/api/books/authors`

- **GET** — distinct author names (via aggregation).
  - Response:
    ```json
    {
      "success": true,
      "message": "N authors found.",
      "data": ["Author One", "Author Two", "..."]
    }
    ```

`/api/books/:bookId`

- **GET** — returns a single book by id. Invalid ids produce a `404 Not Found`.
- **PUT** — partial update; if `copies` provided, `available` auto-updates in middleware.
- **DELETE** — deletes the book; invalid id → `404 Not Found`.

---

### Borrow

`/api/borrow`

- **GET** — aggregated borrow summary.
  - Pipeline groups by `book`, sums `totalQuantity`, joins `books`, sorts by `bookInfo.updatedAt` (desc), and projects a compact payload:
    ```json
    {
      "success": true,
      "message": "N borrowed record(s) found.",
      "data": [
        {
          "book": { "title": "T", "isbn": "X", "imageURI": "..." },
          "totalQuantity": 7
        }
      ]
    }
    ```

- **POST** — create a borrow record (transactional).
  - Body:
    ```json
    {
      "book": "<ObjectId string>",
      "quantity": 1,
      "dueDate": "2025-08-31T00:00:00.000Z"
    }
    ```
  - Behavior:
    - Within a Mongo **transaction**, creates the borrow record and calls `Book.decrementCopies(bookId, quantity, session)`.
    - Ensures **stock cannot go negative** and updates `available`.
  - Success (201):
    ```json
    {
      "success": true,
      "message": "New borrow recorded. Deadline is: Mon Aug 25 2025",
      "data": { /* borrow doc */ }
    }
    ```

---

### Latest & Popular

`/api/books/latest`

- **GET** — latest 5 books.
  - Finds by `createdAt` descending and `limit(5)`:
    ```json
    { "success": true, "message": "Latest books", "data": [ /* up to 5 */ ] }
    ```

`/api/borrow/popular?limit=5` *(optional if implemented)*

- **GET** — top-N most borrowed books.
  - Aggregates `Borrow` by `book`, sorts by `totalQuantity desc`, limits N, joins `books`, and returns:
    ```json
    {
      "success": true,
      "message": "5 most borrowed book(s)",
      "data": [
        {
          "bookId": "<id>",
          "totalQuantity": 12,
          "book": { "title": "T", "isbn": "X", "imageURI": "..." }
        }
      ]
    }
    ```

Alternatively, you can expose `/api/books/popular` if you maintain a `borrowCount` counter on the Book document (see *Notes & Extensibility*).

---

## Pagination, Sorting & Filtering

- **Pagination:** `resultsPerPage` (10/20/50/100) and `page` (1-based). The server uses:
  - `limit(resultsPerPage)`
  - `skip((page - 1) * resultsPerPage)`
- **Sorting:** `sortBy=asc|desc` by `createdAt`.
- **Filtering:** `author`, `genre`, `available` (string → boolean via zod transform).

The list endpoint also returns `booksCount` for client-side pagination controls.

---

## Transactions & Inventory Logic

- **Borrow POST** runs inside a MongoDB session:
  1. Creates the borrow record.
  2. Calls `Book.decrementCopies(bookId, quantity, session)`:
     - Verifies the Book exists.
     - Verifies `copies >= quantity`.
     - Decrements `copies`, sets `available = copies > 0`, and saves in the same transaction.

This ensures **consistency** between borrow records and book stock even under concurrent requests.

---

## Error Handling

Errors are normalized by the global handler (see `global.handlers.ts`). Common cases:

- **Validation errors** (zod): 400 Bad Request with a concise message.
- **CastError / not found** (invalid `:bookId`): 404 Not Found.
- **Duplicate ISBN** (Mongo error code `11000`): 400-like with a clear message.
- **Method not allowed** on unsupported verbs: 405.

**API success responses** follow:

```json
{
  "success": true,
  "message": "Readable message",
  "booksCount": 123,     // only for list endpoints
  "data": { ... }        // or an array
}
```

**API error responses** (shape controlled by the global handler) typically include:

```json
{
  "success": false,
  "message": "Error message",
  "error": { /* optional diagnostics */ }
}
```

---

## Indexing Recommendations

To keep queries and aggregations fast:

```js
// Borrow collection
db.borrow.createIndex({ book: 1 });

// Books collection
db.books.createIndex({ isbn: 1 }, { unique: true });
db.books.createIndex({ createdAt: -1 });       // for /books + /books/latest
// Optional if you add a counter cache:
// db.books.createIndex({ borrowCount: -1 });   // for /books/popular
```

---

## Notes & Extensibility

- **Popular books** can be computed by aggregation (as shown) or by maintaining a **counter cache** (e.g., `borrowCount`) on each Book, incremented in the same borrow transaction. The latter makes `/popular` a simple indexed sort.
- The **author normalization** ensures consistent filter values and a clean authors list.
- The **`available` flag** is always kept in sync with `copies` changes (both transactional decrement and `findOneAndUpdate` middleware).

If you add more filters (e.g., title search), consider adding appropriate indexes and expanding the zod query schema in `books.model.ts`.
